# Excel VBAを用いた確率情報自動化ツール

## 1. プロジェクト概要 (Overview)

本プロジェクトは、手作業で行われていた確率情報データの加工作業を自動化するために開発されたExcel VBAマクロです。反復的なデータ変換プロセスにおけるヒューマンエラーを防止し、業務効率を最大化することを目的としています。

-   **開発期間:** 2024年12月
-   **使用技術:** `Excel VBA`

> **注記:** 本リポジトリに含まれるデータとコードは、実際の業務内容を基にしていますが、セキュリティ保護のため、**等級、アイテム名、確率など、すべての情報を架空の内容に再構成し、大幅に簡略化**したものです。コードは、企業の機密情報を保護しつつ、中核となるロジックと問題解決プロセスを示すために一般化されています。

## 2. 主な機能 (Features)
[demo.mp4](./demo.mp4)
-   **動的なデータ範囲の処理:** ユーザーが`Application.InputBox(Type:=8)`を介して元のデータ範囲を直接選択すると、マクロがヘッダーを自動的に認識してデータを処理します。
-   **データの自動分割と再配置:**
    -   元のデータの総行数に基づいて、データを2つまたは3つのグループに自動的に分割します。
    -   各グループのデータを指定されたフォーマットに合わせて結果シートに再配置します。
-   **書式設定の自動化:**
    -   フォント（Meiryo UI）、列幅、行の高さ、セルの結合、罫線など、標準フォーマットのすべての書式を一括で適用します。
-   **多言語環境への互換性:**
    -   VBAエディタのエンコーディング問題を解決するため、コード内のすべての日本語文字列を`ChrW()`関数とUnicodeコードポイントを使用して処理します。
-   **条件付き確率調整機能:**
    -   3つのグループで構成されるデータの場合、特定のグループの確率値を他のグループの値に簡単に置き換えることができる`ShiftColumnValues`マクロを実装し、複雑なビジネスルールに迅速に対応できるようにしました。

## 3. 技術的な課題と解決策 (Technical Challenges & Solutions)

#### a. データ分割ロジックの柔軟性確保
-   **課題:** 初期には特定の等級名の循環パターンを基準にデータを分割しようとしましたが、一部のアイテムデータには特定の等級が存在しない例外ケースがあり、ロジックが容易に破綻しました。
-   **解決策:** データが常に2つまたは3つの対称的なグループで構成されるというパターンを発見し、**データ行全体を2または3で割り切れるかを確認**した上で機械的に分割する、よりシンプルで堅牢なロジックに変更しました。これにより、各データパターンに合わせた個別のマクロ（`2グループ用`、`3グループ用`）を実装しました。

#### b. VBA環境における日本語文字列の文字化け問題
-   **課題:** VBAエディタ上で「等級」や「確率」などの日本語ヘッダーを直接比較すると、エンコーディングの違いにより文字化け（`?`表示）が発生し、ヘッダーを正常に認識できませんでした。
-   **解決策:** すべての日本語文字列を**`ChrW()`関数と16進数のUnicodeコードポイント**に変換する方式を採用しました。これにより、いかなる実行環境でも安定して文字列を比較・出力できるようになりました。

#### c. 複雑な確率データの書式および値の維持
-   **課題:** `.Value`プロパティでセルの値をコピーすると、Excelが自動的に小数点以下の桁数を変更し、データの精度が損なわれました。また、特定の条件に応じて一部のアイテムグループの確率が他のグループの2倍になるというビジネスロジックを手動で処理する必要がありました。
-   **解決策:**
    1.  **書式の維持:** `Range.Text`プロパティで書式が適用された文字列をそのまま読み込み、`InStr`と`Len`関数で小数点以下の桁数を計算。その上で`NumberFormat`プロパティを動的に生成し、元データと同一の表示形式を再現しました。
    2.  **値の調整自動化:** `ShiftColumnValues`マクロを実装し、3グループの確率データ列を循環(shift)させることで値を交換できるようにしました。これにより、複雑な計算なしに、既存データの完全性を保ちながら、特定条件に合わせた確率値の調整を自動化しました。

## 4. 使い方 (How to Use)

1.  `probability_formatter_tool.xlsm`ファイルを開きます。
2.  `[開発] > [マクロ]`から実行したいマクロ（例: `Magic`）を選択し、実行します。
3.  ポップアップウィンドウの案内に従い、`sample_data_source.xlsx`ファイルのシートに移動し、ヘッダーを含むデータ範囲をドラッグして選択します。
4.  マクロの実行が完了すると、`probability_formatter_tool.xlsm`ファイルの結果シート（例: `3セット`）に変換された結果が自動的に生成されます。
